# OkÃª Sports - Contexto do Projeto

**Plataforma SaaS para gestÃ£o de inscriÃ§Ãµes e eventos esportivos**

**Status:** ğŸ“‹ Planejamento completo | ğŸš€ Pronto para iniciar desenvolvimento
**Ãšltima atualizaÃ§Ã£o:** 31/10/2025
**VersÃ£o do planejamento:** 2.0

---

## ğŸ¯ VISÃƒO GERAL

### O que Ã©?
OkÃª Sports Ã© uma **plataforma marketplace bilateral** que conecta organizadores de eventos esportivos com participantes (atletas), facilitando inscriÃ§Ãµes, pagamentos e gestÃ£o de eventos.

### Diferencial Principal
- **Modelo Marketplace:** Dinheiro vai DIRETO para o organizador via split payment
- **Zero risco financeiro:** Plataforma nÃ£o retÃ©m valores
- **Mais barato:** Taxa de 10% vs 12% da concorrÃªncia (Ticket Sports)
- **Repasse rÃ¡pido:** PIX em D+0, sem taxa de repasse

### Etimologia do Nome
**OkÃª** = "Porta" ou "Entrada" em Tupi-Guarani â†’ perfeito para plataforma de acesso a eventos

---

## ğŸ’° MODELO DE NEGÃ“CIO

### MonetizaÃ§Ã£o (Marketplace Bilateral - Taxa Ãšnica 10%)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PARTICIPANTE                                â”‚
â”‚ InscriÃ§Ã£o: R$ 80,00                         â”‚
â”‚ Taxa OkÃª Sports: R$ 8,00 (10%)              â”‚
â”‚ TOTAL PAGA: R$ 88,00                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ (Mercado Pago Split)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SPLIT AUTOMÃTICO                            â”‚
â”‚ â€¢ Organizador: R$ 79,13 (D+0 para PIX)     â”‚
â”‚ â€¢ OkÃª Sports: R$ 8,00                       â”‚
â”‚ â€¢ Taxa Gateway: R$ 0,87 (paga pelo org)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Modelo simplificado:**
- âœ… **Taxa Ãºnica:** 10% sobre valor da inscriÃ§Ã£o
- âœ… **Sem mensalidade:** 100% gratuito para organizador
- âœ… **Sem limites:** Eventos e inscriÃ§Ãµes ilimitadas
- âœ… **Repasse D+0:** Dinheiro cai direto na conta do organizador via PIX

---

## ğŸ›  STACK TECNOLÃ“GICO DEFINIDO

### Frontend
- **Framework:** Next.js 14+ (App Router, Server Components)
- **Linguagem:** TypeScript
- **Styling:** Tailwind CSS + shadcn/ui
- **FormulÃ¡rios:** React Hook Form + Zod
- **Estado:** Zustand ou React Query
- **GrÃ¡ficos:** Recharts

### Backend
- **Runtime:** Next.js API Routes (MVP) â†’ Node.js/Express (escala)
- **Linguagem:** TypeScript
- **Banco de dados:** PostgreSQL 14+ (Neon/Supabase para MVP)
- **ORM:** Prisma
- **Cache:** Redis (Upstash)
- **Queue:** Bull (se necessÃ¡rio)

### Pagamentos
- **Gateway:** Mercado Pago Marketplace (OAuth + Split Payment)
- **Backup:** Stripe Connect (futuro)
- **Formas:** PIX, CartÃ£o (atÃ© 12x), Boleto

### Email
- **Provider:** Resend
- **Templates:** React Email

### Storage
- **Imagens/Arquivos:** AWS S3 ou Cloudflare R2

### Deploy e Infra
- **Frontend:** Vercel
- **Backend:** Railway ou Render
- **Monitoramento:** Sentry + Uptime Robot
- **Analytics:** PostHog ou Mixpanel

### ğŸš« NÃƒO usar no MVP
- Mobile nativo (React Native/Flutter) - web responsivo primeiro
- MicroserviÃ§os - monolito modular
- GraphQL - REST Ã© suficiente
- Docker/K8s - overkill para MVP

---

## ğŸ— ARQUITETURA DETALHADA

### VisÃ£o Geral (Camadas)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CAMADA DE APRESENTAÃ‡ÃƒO                  â”‚
â”‚  Next.js 14 (App Router + Server Components)   â”‚
â”‚  â€¢ Landing Pages PÃºblicas                       â”‚
â”‚  â€¢ Dashboard Organizador                        â”‚
â”‚  â€¢ Marketplace Atleta                           â”‚
â”‚  â€¢ PÃ¡ginas de Evento (hotsite)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CAMADA DE APLICAÃ‡ÃƒO                   â”‚
â”‚         Next.js API Routes (REST)               â”‚
â”‚  â€¢ /api/auth/* (login, register, refresh)       â”‚
â”‚  â€¢ /api/events/* (CRUD eventos)                 â”‚
â”‚  â€¢ /api/registrations/* (inscriÃ§Ãµes)            â”‚
â”‚  â€¢ /api/payments/* (checkout, status)           â”‚
â”‚  â€¢ /api/webhooks/mercadopago                    â”‚
â”‚  â€¢ /api/organizers/* (dashboard, stats)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          CAMADA DE DOMÃNIO (Services)           â”‚
â”‚  â€¢ AuthService (JWT, sessions)                  â”‚
â”‚  â€¢ EventService (business logic)                â”‚
â”‚  â€¢ PaymentService (Mercado Pago SDK)            â”‚
â”‚  â€¢ RegistrationService (inscriÃ§Ãµes)             â”‚
â”‚  â€¢ EmailService (Resend)                        â”‚
â”‚  â€¢ UploadService (S3/R2)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          CAMADA DE DADOS (Prisma ORM)           â”‚
â”‚         PostgreSQL Database                      â”‚
â”‚  â€¢ Tabelas: User, Event, Registration,          â”‚
â”‚    Batch, Coupon, Payment, OAuthToken           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        SERVIÃ‡OS EXTERNOS (IntegraÃ§Ãµes)          â”‚
â”‚  â€¢ Mercado Pago (OAuth + Payments + Webhooks)   â”‚
â”‚  â€¢ Resend (Emails transacionais)                â”‚
â”‚  â€¢ AWS S3 / Cloudflare R2 (Storage)             â”‚
â”‚  â€¢ Redis / Upstash (Cache + Sessions)           â”‚
â”‚  â€¢ Sentry (Error tracking)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ MODELO DE DADOS COMPLETO

### **1. ORGANIZADOR (User)**
```typescript
model User {
  // IdentificaÃ§Ã£o
  id                 String    @id @default(cuid())
  email              String    @unique
  password           String    // bcrypt hash

  // Dados Pessoais
  fullName           String
  cpfCnpj            String    @unique
  phone              String

  // EndereÃ§o
  address            Address?  @relation

  // Mercado Pago OAuth
  mpConnected        Boolean   @default(false)
  mpUserId           String?   @unique
  mpAccessToken      String?   // AES-256 encrypted
  mpRefreshToken     String?   // AES-256 encrypted
  mpPublicKey        String?
  mpTokenExpiresAt   DateTime?

  // Relacionamentos
  events             Event[]

  // Auditoria
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastLoginAt        DateTime?
  emailVerified      Boolean   @default(false)
  emailVerifiedAt    DateTime?
}

model Address {
  id          String  @id @default(cuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id])

  cep         String
  street      String
  number      String
  complement  String?
  neighborhood String
  city        String
  state       String  // UF (SP, RJ, etc)
  country     String  @default("BR")
}
```

---

### **2. ATLETA (Participant)**
```typescript
model Participant {
  // IdentificaÃ§Ã£o
  id                 String    @id @default(cuid())
  email              String    @unique
  password           String?   // null se criado por terceiro

  // Dados Pessoais
  fullName           String
  cpf                String    @unique
  phone              String
  birthDate          DateTime
  gender             Gender?   @default(NOT_INFORMED)

  // EndereÃ§o Completo
  address            ParticipantAddress?

  // Relacionamentos
  registrations      Registration[]

  // ConfiguraÃ§Ãµes
  receiveMarketing   Boolean   @default(true)

  // Auditoria
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastLoginAt        DateTime?
  emailVerified      Boolean   @default(false)
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NOT_INFORMED
}

model ParticipantAddress {
  id             String      @id @default(cuid())
  participantId  String      @unique
  participant    Participant @relation(fields: [participantId], references: [id])

  cep            String
  street         String
  number         String
  complement     String?
  neighborhood   String
  city           String
  state          String
  country        String      @default("BR")
}
```

---

### **3. EVENTO (Event)**
```typescript
model Event {
  // IdentificaÃ§Ã£o
  id                String    @id @default(cuid())
  slug              String    @unique // URL amigÃ¡vel: corrida-sp-2025

  // InformaÃ§Ãµes BÃ¡sicas
  name              String    // "Corrida de SÃ£o Paulo 2025"
  description       String    @db.Text
  shortDescription  String?   // Resumo para cards

  // Datas
  eventDate         DateTime  // Data do evento real
  registrationStart DateTime  // InÃ­cio das inscriÃ§Ãµes
  registrationEnd   DateTime  // Fim das inscriÃ§Ãµes

  // LocalizaÃ§Ã£o
  location          EventLocation?

  // Visual
  bannerUrl         String?   // Banner principal
  logoUrl           String?   // Logo do evento
  coverUrl          String?   // Capa para redes sociais

  // ConfiguraÃ§Ãµes
  status            EventStatus @default(DRAFT)
  maxRegistrations  Int?      // Limite total de vagas (null = ilimitado)
  allowGroupReg     Boolean   @default(true) // Permitir inscrever terceiros
  maxGroupSize      Int       @default(10)   // Limite de pessoas por compra

  // DNS Customizado (futuro)
  customDomain      String?   @unique

  // Relacionamentos
  organizerId       String
  organizer         User      @relation(fields: [organizerId], references: [id])

  modalities        Modality[]
  batches           Batch[]
  coupons           Coupon[]
  registrations     Registration[]

  // Auditoria
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  publishedAt       DateTime?

  @@index([slug])
  @@index([eventDate])
  @@index([status])
}

enum EventStatus {
  DRAFT          // Rascunho
  PUBLISHED      // Publicado (inscriÃ§Ãµes abertas)
  PAUSED         // Pausado (visÃ­vel mas nÃ£o aceita inscriÃ§Ãµes)
  SOLD_OUT       // Esgotado
  FINISHED       // Evento jÃ¡ aconteceu
  CANCELLED      // Cancelado
}

model EventLocation {
  id          String  @id @default(cuid())
  eventId     String  @unique
  event       Event   @relation(fields: [eventId], references: [id])

  venueName   String? // Nome do local (ex: Parque Ibirapuera)
  street      String
  number      String
  complement  String?
  neighborhood String
  city        String
  state       String
  cep         String

  // Coordenadas para mapa
  latitude    Float?
  longitude   Float?
}
```

---

### **4. MODALIDADES (Modality)**
```typescript
model Modality {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Dados da Modalidade
  name        String   // "5km", "10km", "21km"
  description String?  // Detalhes adicionais
  price       Decimal  @db.Decimal(10, 2) // PreÃ§o base

  // Limites
  maxSlots    Int?     // Vagas disponÃ­veis (null = ilimitado)
  soldSlots   Int      @default(0) // Vendidas

  // Ordem de exibiÃ§Ã£o
  order       Int      @default(0)

  // Status
  active      Boolean  @default(true)

  // Relacionamentos
  registrations Registration[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([eventId])
}
```

---

### **5. LOTES (Batch)**
```typescript
model Batch {
  id          String    @id @default(cuid())
  eventId     String
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Dados do Lote
  name        String    // "1Âº Lote", "Early Bird"

  // Tipo de Lote
  type        BatchType @default(DATE) // Por data ou volume

  // PerÃ­odo (se type = DATE)
  startDate   DateTime?
  endDate     DateTime?

  // Volume (se type = VOLUME)
  maxSales    Int?      // MÃ¡ximo de vendas neste lote
  currentSales Int      @default(0)

  // Desconto
  discountType     DiscountType? // PERCENTAGE ou FIXED
  discountValue    Decimal?      @db.Decimal(10, 2)

  // Status
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([eventId])
}

enum BatchType {
  DATE    // Por perÃ­odo de tempo
  VOLUME  // Por quantidade vendida
}

enum DiscountType {
  PERCENTAGE  // Percentual (ex: 10%)
  FIXED       // Valor fixo (ex: R$ 20)
}
```

---

### **6. CUPONS (Coupon)**
```typescript
model Coupon {
  id              String       @id @default(cuid())
  eventId         String
  event           Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // CÃ³digo
  code            String       // CORRIDA10, AMIGO20

  // Desconto
  discountType    DiscountType // PERCENTAGE ou FIXED
  discountValue   Decimal      @db.Decimal(10, 2)

  // Validade
  startDate       DateTime
  endDate         DateTime

  // Limites
  maxUses         Int?         // null = ilimitado
  currentUses     Int          @default(0)

  // RestriÃ§Ãµes
  modalityIds     String[]     // Array de IDs (vazio = todas)
  minPurchase     Decimal?     @db.Decimal(10, 2)

  // Status
  active          Boolean      @default(true)

  // Relacionamentos
  registrations   Registration[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([eventId, code])
  @@index([code])
}
```

---

### **7. INSCRIÃ‡ÃƒO (Registration)**
```typescript
model Registration {
  id                String       @id @default(cuid())

  // Relacionamentos
  eventId           String
  event             Event        @relation(fields: [eventId], references: [id])

  modalityId        String
  modality          Modality     @relation(fields: [modalityId], references: [id])

  participantId     String
  participant       Participant  @relation(fields: [participantId], references: [id])

  // Quem comprou (pode ser diferente do participante)
  buyerId           String?      // Participant.id de quem fez a compra

  // Cupom
  couponId          String?
  coupon            Coupon?      @relation(fields: [couponId], references: [id])

  // Valores
  basePrice         Decimal      @db.Decimal(10, 2) // PreÃ§o original
  discount          Decimal      @db.Decimal(10, 2) @default(0)
  subtotal          Decimal      @db.Decimal(10, 2) // basePrice - discount
  platformFee       Decimal      @db.Decimal(10, 2) // 10% da subtotal
  total             Decimal      @db.Decimal(10, 2) // subtotal + platformFee

  // Pagamento
  paymentId         String?      @unique // ID do Mercado Pago
  paymentStatus     PaymentStatus @default(PENDING)
  paymentMethod     String?      // pix, credit_card, boleto

  // NÃºmero da InscriÃ§Ã£o (sequencial por evento)
  registrationNumber Int

  // Status
  status            RegistrationStatus @default(PENDING)

  // Check-in (futuro)
  checkedIn         Boolean      @default(false)
  checkedInAt       DateTime?

  // Auditoria
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  confirmedAt       DateTime?    // Quando pagamento confirmado
  cancelledAt       DateTime?

  @@index([eventId])
  @@index([participantId])
  @@index([paymentId])
  @@unique([eventId, registrationNumber])
}

enum PaymentStatus {
  PENDING       // Aguardando pagamento
  PROCESSING    // Processando
  APPROVED      // Aprovado
  REJECTED      // Rejeitado
  CANCELLED     // Cancelado
  REFUNDED      // Reembolsado
}

enum RegistrationStatus {
  PENDING       // Aguardando pagamento
  CONFIRMED     // Confirmada (paga)
  CANCELLED     // Cancelada
}
```

---

## ğŸ”„ FLUXOS DETALHADOS

### **Fluxo 1: OAuth Mercado Pago**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ORGANIZADOR CLICA "CONECTAR MERCADO PAGO"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. GERAR STATE (CSRF Token)                        â”‚
â”‚    state = crypto.randomBytes(32).toString('hex')  â”‚
â”‚    Salvar em session/Redis com TTL 10min           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. REDIRECT PARA MERCADO PAGO OAuth                â”‚
â”‚    URL: https://auth.mercadopago.com/authorization  â”‚
â”‚    Params:                                          â”‚
â”‚      - client_id={MP_CLIENT_ID}                    â”‚
â”‚      - response_type=code                           â”‚
â”‚      - platform_id=mp                               â”‚
â”‚      - state={state}                                â”‚
â”‚      - redirect_uri={APP_URL}/api/auth/mp/callback â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. USUÃRIO AUTORIZA NO MERCADO PAGO                â”‚
â”‚    (Login, permissÃµes, aceitar)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. CALLBACK: /api/auth/mp/callback                 â”‚
â”‚    Recebe: ?code={auth_code}&state={state}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. VALIDAR STATE                                    â”‚
â”‚    if (state !== sessionState) throw Error         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. TROCAR CODE POR ACCESS_TOKEN                    â”‚
â”‚    POST https://api.mercadopago.com/oauth/token     â”‚
â”‚    Body: {                                          â”‚
â”‚      grant_type: 'authorization_code',              â”‚
â”‚      client_id: MP_CLIENT_ID,                       â”‚
â”‚      client_secret: MP_CLIENT_SECRET,               â”‚
â”‚      code: auth_code,                               â”‚
â”‚      redirect_uri: CALLBACK_URL                     â”‚
â”‚    }                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. RECEBER TOKENS                                   â”‚
â”‚    Response: {                                      â”‚
â”‚      access_token: "APP_USR-xxx",                   â”‚
â”‚      refresh_token: "TG-xxx",                       â”‚
â”‚      user_id: 123456789,                            â”‚
â”‚      public_key: "APP_USR-xxx",                     â”‚
â”‚      expires_in: 15552000 (180 dias)                â”‚
â”‚    }                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. CRIPTOGRAFAR E SALVAR NO BANCO                  â”‚
â”‚    User.update({                                    â”‚
â”‚      mpConnected: true,                             â”‚
â”‚      mpUserId: user_id,                             â”‚
â”‚      mpAccessToken: encrypt(access_token),          â”‚
â”‚      mpRefreshToken: encrypt(refresh_token),        â”‚
â”‚      mpPublicKey: public_key,                       â”‚
â”‚      mpTokenExpiresAt: now + expires_in             â”‚
â”‚    })                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. REDIRECT PARA DASHBOARD                        â”‚
â”‚     âœ… "Mercado Pago conectado com sucesso!"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **Fluxo 2: Checkout e Pagamento**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ATLETA FINALIZA CARRINHO                       â”‚
â”‚    Carrinho: [                                     â”‚
â”‚      {JoÃ£o, 5km, R$ 88},                           â”‚
â”‚      {Maria, 10km, R$ 128}                         â”‚
â”‚    ]                                               â”‚
â”‚    Total: R$ 216,00                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. POST /api/checkout                              â”‚
â”‚    Body: {                                         â”‚
â”‚      eventId,                                      â”‚
â”‚      items: [{participantData, modalityId, ...}]   â”‚
â”‚    }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. VALIDAÃ‡Ã•ES                                      â”‚
â”‚    â€¢ Evento ativo?                                 â”‚
â”‚    â€¢ Vagas disponÃ­veis?                            â”‚
â”‚    â€¢ Cupons vÃ¡lidos?                               â”‚
â”‚    â€¢ Organizador tem MP conectado?                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. CRIAR REGISTRATIONS (status: PENDING)          â”‚
â”‚    Salvar no banco com paymentStatus: PENDING     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. DESCRIPTOGRAFAR mpAccessToken DO ORGANIZADOR   â”‚
â”‚    token = decrypt(organizer.mpAccessToken)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. CRIAR PREFERENCE NO MERCADO PAGO               â”‚
â”‚    POST https://api.mercadopago.com/checkout/      â”‚
â”‚         preferences                                â”‚
â”‚    Headers: Authorization: Bearer {access_token}   â”‚
â”‚    Body: {                                         â”‚
â”‚      items: [{                                     â”‚
â”‚        title: "InscriÃ§Ã£o - Corrida SP",            â”‚
â”‚        quantity: 1,                                â”‚
â”‚        unit_price: 216.00                          â”‚
â”‚      }],                                           â”‚
â”‚      marketplace_fee: 21.60, // 10% split          â”‚
â”‚      notification_url: "{APP_URL}/api/webhooks/mp",â”‚
â”‚      back_urls: {...},                             â”‚
â”‚      external_reference: registrationIds.join(',') â”‚
â”‚    }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. RECEBER PREFERENCE ID                          â”‚
â”‚    Response: {                                     â”‚
â”‚      id: "123456789-abc-def",                      â”‚
â”‚      init_point: "https://www.mercadopago.com/..." â”‚
â”‚    }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. REDIRECT ATLETA PARA MERCADO PAGO              â”‚
â”‚    window.location = preference.init_point         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ATLETA PAGA (PIX, CartÃ£o, Boleto)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. MERCADO PAGO PROCESSA PAGAMENTO               â”‚
â”‚     â€¢ PIX: aprovaÃ§Ã£o instantÃ¢nea                   â”‚
â”‚     â€¢ CartÃ£o: anÃ¡lise antifraude (~2min)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. WEBHOOK: POST /api/webhooks/mercadopago       â”‚
â”‚     Body: {                                        â”‚
â”‚       action: "payment.created",                   â”‚
â”‚       data: { id: "payment_id" }                   â”‚
â”‚     }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
     (Continua no Fluxo 3: Webhook)
```

---

### **Fluxo 3: Webhook Mercado Pago**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. RECEBER WEBHOOK                                 â”‚
â”‚    POST /api/webhooks/mercadopago                  â”‚
â”‚    Headers: x-signature, x-request-id              â”‚
â”‚    Body: { action, data: { id } }                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. VALIDAR ASSINATURA (SeguranÃ§a)                 â”‚
â”‚    Verificar x-signature com MP_WEBHOOK_SECRET    â”‚
â”‚    if (!valid) return 401                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. VERIFICAR IDEMPOTÃŠNCIA                         â”‚
â”‚    if (processedWebhooks.has(x-request-id))        â”‚
â”‚      return 200 // JÃ¡ processado                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. BUSCAR DETALHES DO PAGAMENTO                   â”‚
â”‚    GET https://api.mercadopago.com/v1/payments/{id}â”‚
â”‚    Headers: Authorization: Bearer {access_token}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RECEBER DADOS DO PAGAMENTO                     â”‚
â”‚    Response: {                                     â”‚
â”‚      id,                                           â”‚
â”‚      status: "approved",                           â”‚
â”‚      status_detail,                                â”‚
â”‚      external_reference: "reg1,reg2,reg3",         â”‚
â”‚      transaction_amount: 216.00,                   â”‚
â”‚      payment_method_id: "pix"                      â”‚
â”‚    }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. EXTRAIR REGISTRATION IDs                       â”‚
â”‚    registrationIds = external_reference.split(',') â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ATUALIZAR REGISTRATIONS NO BANCO               â”‚
â”‚    Registration.updateMany({                       â”‚
â”‚      where: { id: { in: registrationIds } },       â”‚
â”‚      data: {                                       â”‚
â”‚        paymentId: payment.id,                      â”‚
â”‚        paymentStatus: "APPROVED",                  â”‚
â”‚        status: "CONFIRMED",                        â”‚
â”‚        paymentMethod: "pix",                       â”‚
â”‚        confirmedAt: now()                          â”‚
â”‚      }                                             â”‚
â”‚    })                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ATUALIZAR SLOTS DA MODALIDADE                  â”‚
â”‚    Modality.increment({ soldSlots: +2 })           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ENVIAR EMAILS DE CONFIRMAÃ‡ÃƒO                   â”‚
â”‚    Para cada registration:                         â”‚
â”‚      - Email para participante                     â”‚
â”‚      - Email para organizador (resumo)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. MARCAR WEBHOOK COMO PROCESSADO                â”‚
â”‚     Cache.set(x-request-id, true, TTL: 24h)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. RETORNAR 200 OK                                â”‚
â”‚     (MP requer resposta rÃ¡pida < 5s)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SeguranÃ§a
- **AutenticaÃ§Ã£o:** JWT (access + refresh token)
- **Criptografia:** tokens OAuth via crypto (AES-256-GCM)
- **Rate Limiting:** 100 req/15min por IP
- **SanitizaÃ§Ã£o:** Zod validation em todas inputs
- **LGPD:** desde M1 (termos, privacidade, consentimento)
- **Webhook Signature:** ValidaÃ§Ã£o obrigatÃ³ria de assinatura MP
- **IdempotÃªncia:** Prevenir processamento duplicado de webhooks

---

## ğŸ“‹ STATUS ATUAL DO PROJETO

### âœ… ConcluÃ­do
- [x] Planejamento estratÃ©gico completo
- [x] Modelo de negÃ³cio definido e validado
- [x] Stack tecnolÃ³gico escolhido
- [x] Milestones detalhados (M0-M16)
- [x] Tasks quebradas (91 SP para MVP)
- [x] Scripts de setup GitHub prontos
- [x] **M0: ValidaÃ§Ã£o de Mercado** - Considerado validado
- [x] **M1.1: Setup do Projeto** - Next.js 14 + Prisma + Tailwind

### ğŸš§ Em Andamento
- [ ] **M1.2: AutenticaÃ§Ã£o (JWT)** - PrÃ³ximo passo

### ğŸ“… PrÃ³ximos Passos (Super MVP)
1. **M1.2: AutenticaÃ§Ã£o** (2-3 dias)
   - JWT (access + refresh token)
   - Login/Register (Organizador)
   - Middleware de autenticaÃ§Ã£o
   - Password hash (bcrypt)

2. **M1.3: OAuth Mercado Pago** (3-4 dias)
   - Fluxo OAuth completo
   - Callback + token storage
   - Criptografia AES-256
   - ValidaÃ§Ã£o de conexÃ£o

3. **M2: CRUD de Eventos** (5-7 dias)
   - Criar/Editar eventos
   - Modalidades e Lotes
   - Upload de imagens
   - Slug Ãºnico

4. **M3: Checkout + Pagamento PIX** (5-7 dias)
   - Carrinho de inscriÃ§Ãµes
   - Preference do Mercado Pago
   - Split payment automÃ¡tico
   - Webhook handler

5. **CHECKPOINT 1:** Validar com 3-5 organizadores reais

---

## ğŸ“ CONVENÃ‡Ã•ES DE CÃ“DIGO

### Branches
```
feature/M1.1-setup-projeto
fix/payment-webhook-error
refactor/auth-middleware
docs/update-readme
```

### Commits (Conventional Commits)
```
feat(auth): implementar login com JWT
fix(payment): corrigir validaÃ§Ã£o de webhook
refactor(db): otimizar query de inscriÃ§Ãµes
docs(readme): adicionar instruÃ§Ãµes de setup
test(e2e): adicionar teste de checkout
```

### Estrutura de Pastas
```
src/
â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/            # Grupo de rotas: login, register
â”‚   â”œâ”€â”€ (dashboard)/       # Grupo de rotas: Ã¡rea do organizador
â”‚   â”œâ”€â”€ (public)/          # Landing pages pÃºblicas
â”‚   â””â”€â”€ api/               # API routes
â”‚       â”œâ”€â”€ auth/
â”‚       â”œâ”€â”€ events/
â”‚       â”œâ”€â”€ payments/
â”‚       â””â”€â”€ webhooks/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                # Componentes base (shadcn)
â”‚   â””â”€â”€ features/          # Componentes de feature
â”‚       â”œâ”€â”€ auth/
â”‚       â”œâ”€â”€ events/
â”‚       â””â”€â”€ payments/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ db.ts             # Prisma client
â”‚   â”œâ”€â”€ auth.ts           # JWT helpers
â”‚   â”œâ”€â”€ mercadopago.ts    # MP SDK wrapper
â”‚   â””â”€â”€ email.ts          # Resend wrapper
â”œâ”€â”€ types/                # TypeScript types
â””â”€â”€ utils/                # FunÃ§Ãµes auxiliares
```

### Nomenclatura
- **Componentes:** PascalCase (`EventCard.tsx`)
- **FunÃ§Ãµes:** camelCase (`createPayment()`)
- **Constantes:** UPPER_SNAKE_CASE (`MAX_UPLOAD_SIZE`)
- **Arquivos:** kebab-case (`user-profile.ts`)
- **Types/Interfaces:** PascalCase com `I` ou `T` prefix opcional

---

## ğŸ” VARIÃVEIS DE AMBIENTE

```bash
# Database
DATABASE_URL="postgresql://..."

# Auth
JWT_SECRET="..."
JWT_REFRESH_SECRET="..."
ENCRYPTION_KEY="..." # 32 bytes para AES-256

# Mercado Pago
MP_CLIENT_ID="..."
MP_CLIENT_SECRET="..."
MP_ACCESS_TOKEN="..." # Token da OkÃª Sports (receber split)
MP_PUBLIC_KEY="..."

# Email
RESEND_API_KEY="..."

# Storage
AWS_ACCESS_KEY_ID="..."
AWS_SECRET_ACCESS_KEY="..."
AWS_BUCKET_NAME="..."

# App
NEXT_PUBLIC_APP_URL="https://okesports.com.br"
NEXT_PUBLIC_API_URL="https://api.okesports.com.br"

# Monitoramento
SENTRY_DSN="..."
```

---

## ğŸ“Š MÃ‰TRICAS DE SUCESSO

### Checkpoint 1 (Semana 4 - MVP)
- [ ] 3-5 organizadores testando
- [ ] 1 evento real publicado
- [ ] 50+ inscriÃ§Ãµes processadas
- [ ] PIX + CartÃ£o 100% funcionais
- [ ] Taxa de sucesso pagamento > 95%

### Checkpoint 2 (MÃªs 3 - Crescimento)
- [ ] 10+ organizadores pagantes
- [ ] 5+ eventos simultÃ¢neos
- [ ] 200+ inscriÃ§Ãµes/mÃªs
- [ ] ConversÃ£o > 30%
- [ ] NPS > 40

### Checkpoint 3 (MÃªs 6 - Escala)
- [ ] 50+ organizadores ativos
- [ ] 20+ eventos/mÃªs
- [ ] 1.000+ inscriÃ§Ãµes/mÃªs
- [ ] GMV: R$ 50k+/mÃªs
- [ ] Churn < 10%

### Meta Ano 1
- [ ] 200+ organizadores
- [ ] 4-5k inscriÃ§Ãµes/mÃªs
- [ ] GMV: R$ 200-250k/mÃªs
- [ ] Receita OkÃª: R$ 10-12k/mÃªs
- [ ] Breakeven ou lucratividade

---

## ğŸš¨ DECISÃ•ES IMPORTANTES

### 1. Por que modelo Marketplace?
**DecisÃ£o:** Organizador conecta sua prÃ³pria conta do gateway (OAuth)
**Vantagem:**
- âœ… Zero risco financeiro para plataforma
- âœ… NÃ£o somos instituiÃ§Ã£o de pagamento
- âœ… Sem compliance bancÃ¡rio complexo
- âœ… Organizador recebe dinheiro direto
- âœ… Mais confianÃ§a do organizador

**Trade-off:**
- âŒ Requer onboarding do organizador (conectar MP)
- âŒ DependÃªncia do gateway (mas baixa - split nativo)

### 2. Por que Mercado Pago e nÃ£o Stripe?
**DecisÃ£o:** Mercado Pago como gateway principal
**Vantagem:**
- âœ… Split payment nativo
- âœ… PIX com taxa de 0,99% (Stripe: 1%)
- âœ… Reconhecimento de marca no Brasil
- âœ… Suporte em portuguÃªs
- âœ… DocumentaÃ§Ã£o completa

**Manter Stripe como backup para futuro**

### 3. Por que Next.js e nÃ£o separar front/back?
**DecisÃ£o:** Monolito Next.js no MVP
**Vantagem:**
- âœ… Mais rÃ¡pido de desenvolver
- âœ… SSR nativo (melhor SEO)
- âœ… API Routes integradas
- âœ… Deploy simplificado (Vercel)
- âœ… Type-safety full-stack

**Futuro:** Separar em microsserviÃ§os se necessÃ¡rio (escala)

### 4. Por que PIX + CartÃ£o no MVP?
**DecisÃ£o:** Incluir cartÃ£o de crÃ©dito desde o inÃ­cio (nÃ£o sÃ³ PIX)
**Vantagem:**
- âœ… Eventos esportivos custam R$ 80-300
- âœ… PÃºblico quer parcelar
- âœ… PIX sozinho limita vendas
- âœ… Mais credibilidade profissional

**Essential para mostrar valor real**

### 5. Por que Freemium e nÃ£o sÃ³ Split?
**DecisÃ£o:** Modelo freemium com planos
**Vantagem:**
- âœ… Reduz barreira de entrada (plano free)
- âœ… MRR previsÃ­vel (planos pagos)
- âœ… Upsell natural (limites free)
- âœ… SegmentaÃ§Ã£o de clientes

**Trade-off:**
- âŒ Complexidade adicional no cÃ³digo
- âŒ Precisa gerenciar limites/cotas

---

## ğŸ“š REFERÃŠNCIAS ÃšTEIS

### DocumentaÃ§Ã£o Principal
- **Mercado Pago Marketplace:** https://www.mercadopago.com.br/developers/pt/docs/mp-marketplace
- **Next.js 14:** https://nextjs.org/docs
- **Prisma:** https://www.prisma.io/docs
- **Resend:** https://resend.com/docs
- **shadcn/ui:** https://ui.shadcn.com

### InspiraÃ§Ã£o de UX
- **Ticket Sports:** referÃªncia de features (nÃ£o de preÃ§o)
- **Sympla:** checkout e busca de eventos
- **Eventbrite:** dashboard e relatÃ³rios

### Competitors
- Ticket Sports (principal)
- Sympla (eventos gerais)
- InscriÃ§ÃµesOnline (pequeno)
- Tottem (bÃ¡sico)

---

## ğŸ¨ DESIGN SYSTEM

### Paleta de Cores
```css
:root {
  --primary: #2563eb;      /* Blue - aÃ§Ãµes principais */
  --secondary: #10b981;    /* Green - sucesso, confirmaÃ§Ã£o */
  --danger: #ef4444;       /* Red - erros, cancelar */
  --warning: #f59e0b;      /* Orange - alertas */
  --gray: #6b7280;         /* Gray - textos secundÃ¡rios */
  --dark: #1f2937;         /* Dark gray - textos principais */
}
```

### Tipografia
- **Font:** Inter ou System Font (-apple-system)
- **Heading:** 600-700 weight
- **Body:** 400 weight
- **Small:** 300 weight

### Componentes Base (shadcn/ui)
- Button
- Input
- Card
- Badge
- Alert
- Dialog
- Dropdown Menu
- Table
- Tabs

---

## ğŸ› DEBUG TIPS

### Problemas Comuns

**1. Webhook nÃ£o funcionando localmente**
```bash
# Usar ngrok ou Mercado Pago Test Webhooks
ngrok http 3000
# Configurar URL no painel MP: https://xxx.ngrok.io/api/webhooks/mercadopago
```

**2. OAuth redirect loop**
```bash
# Verificar NEXT_PUBLIC_APP_URL estÃ¡ correto
# Verificar callback_url configurado no MP
```

**3. Pagamento nÃ£o aparece no dashboard**
```bash
# Verificar webhook chegou (logs)
# Verificar paymentId salvo corretamente na inscriÃ§Ã£o
# Verificar status do pagamento no Mercado Pago
```

**4. Erro de CORS**
```bash
# Adicionar em next.config.js:
async headers() {
  return [
    {
      source: '/api/:path*',
      headers: [
        { key: 'Access-Control-Allow-Origin', value: '*' }
      ]
    }
  ]
}
```

---

## ğŸ¤ COMO CONTRIBUIR

### Workflow
1. Pegar issue do GitHub (atribuir a si mesmo)
2. Criar branch: `git checkout -b feature/M1.1-nome`
3. Desenvolver + testes
4. Commit seguindo convenÃ§Ãµes
5. Push e abrir PR
6. Code review (mÃ­nimo 1 aprovaÃ§Ã£o)
7. Merge â†’ Deploy automÃ¡tico

### Code Review Checklist
- [ ] CÃ³digo segue convenÃ§Ãµes
- [ ] Testes passando
- [ ] TypeScript sem erros
- [ ] Sem console.logs deixados
- [ ] Tratamento de erros adequado
- [ ] DocumentaÃ§Ã£o atualizada (se necessÃ¡rio)

---

## ğŸ“ LINKS IMPORTANTES

### RepositÃ³rio
- **GitHub:** https://github.com/[usuario]/OkeSports

### Ambientes
- **Staging:** https://staging.okesports.com.br
- **ProduÃ§Ã£o:** https://okesports.com.br (futuro)

### Ferramentas
- **Figma:** [link do design]
- **Notion:** [link da documentaÃ§Ã£o]
- **Slack:** [link do workspace]

### Mercado Pago
- **Dashboard:** https://www.mercadopago.com.br/developers
- **Sandbox:** https://www.mercadopago.com.br/developers/panel/test-accounts

---

## ğŸ¯ FOCO ATUAL

**Status:** M1.2 completo âœ… | PrÃ³ximo: M1.3 OAuth Mercado Pago
**Sprint Atual:** M1 (Setup e Core MÃ­nimo)
**PrÃ³xima Sprint:** M2 (CRUD de Eventos)

**Progresso M1:**
1. âœ… M1.1 - Setup inicial (Next.js, Tailwind, Prisma)
2. âœ… M1.2 - AutenticaÃ§Ã£o (JWT, Register, Login, Refresh Token)
3. ğŸš§ M1.3 - OAuth Mercado Pago
4. ğŸ“… M1.4 - Dashboard bÃ¡sico do organizador

---

## ğŸ’¡ DICAS PARA O CLAUDE

### Ao ajudar com cÃ³digo:
- Sempre usar TypeScript (nÃ£o JavaScript puro)
- Preferir Server Components no Next.js (usar 'use client' apenas quando necessÃ¡rio)
- Validar inputs com Zod
- Tratar erros com try/catch
- Retornar tipos corretos nas API routes
- Criptografar dados sensÃ­veis
- Adicionar comentÃ¡rios em lÃ³gicas complexas

### Ao criar componentes:
- Usar shadcn/ui como base
- Componentes pequenos e focados
- Props tipadas com TypeScript
- Acessibilidade (ARIA labels)
- Responsivo (mobile-first)

### Ao trabalhar com pagamentos:
- NUNCA expor access_token em logs
- Sempre validar assinatura de webhooks
- Tratar todos os status de pagamento
- IdempotÃªncia em webhooks (nÃ£o processar 2x)
- Usar sandbox do MP para testes

---

**Este arquivo Ã© atualizado automaticamente pelo Claude Code durante o desenvolvimento.**

**Ãšltima sincronizaÃ§Ã£o:** 06/11/2025
